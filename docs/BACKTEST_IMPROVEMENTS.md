# 백테스트 개선 사항 (2025-12-17)

## 📊 이전 결과 분석 (1분봉)

### 심각한 문제점:
1. **전체 적자**: -$2,897.40 (-1.54%)
2. **낮은 승률**: 38.63% (1877개 거래 중 725개 승리)
3. **불균형한 손익비**: 평균 승리 $13.80 vs 평균 손실 -$11.20 (약 1.2:1)
4. **과도한 신호**: 1877개 거래 = 신호 필터링 부족
5. **고변동성 코인 문제**: 70-80% 변동성 코인은 예측 불가능
6. **느린 속도**: 코인당 79.93초 (신호 탐색 97.4%)

### 코인별 성과:
- **수익**: EDENUSDT (+$679), SAROSUSDT (+$124)
- **최악**: PTBUSDT (-$930, 284거래, 승률 31.7%)
- **나머지 8개 코인 모두 적자**

---

## 🔧 적용한 개선 사항

### 1. 리스크 관리 개선 (손익비 향상)
**파일**: `config/config.py`

```python
# 변경 전
TAKE_PROFIT_PERCENT = 1.5  # 익절 1.5%
# 손익비: 1.5:1 (승률 38%로는 적자)

# 변경 후
TAKE_PROFIT_PERCENT = 2.0  # 익절 2.0%
# 손익비: 2:1 (승률 40%면 수익 가능)
```

**효과**: 
- 평균 승리 수익 증가: $13.80 → $18.40 (예상)
- 손익비 개선: 1.2:1 → 1.8:1
- 승률 40%만 되어도 수익 가능

---

### 2. 신호 필터 강화 (신뢰도 기준 상향)
**파일**: `src/strategies/entry_strategy.py`

```python
# 변경 전
if confidence >= 70:  # 하락 추세 숏
if confidence >= 70:  # 상승 추세 롱
if confidence >= 75:  # 지지선 반등

# 변경 후
if confidence >= 80:  # 하락 추세 숏 (더 엄격)
if confidence >= 80:  # 상승 추세 롱 (더 엄격)
if confidence >= 85:  # 지지선 반등 (더 엄격)
```

**효과**:
- 거래 수 감소: 1877개 → 약 800-1000개 (예상)
- 승률 향상: 38.63% → 45-50% (예상)
- 저품질 신호 제거

---

### 3. 변동성 필터 추가 (고변동성 코인 제외)
**파일**: `config/config.py`, `src/backtesting/backtest_engine.py`

```python
# 신규 추가
MAX_VOLATILITY = 50.0  # 최대 변동성 50% (너무 높으면 예측 불가)

# 필터링 로직
filtered_coins = scanned_coins[
    (scanned_coins['volatility_24h'] >= 5.0) &
    (scanned_coins['volatility_24h'] <= 50.0)  # 50% 이하만
]
```

**제외되는 코인**:
- PTBUSDT (82.47%) - 최악의 성과 (-$930)
- CYSUSDT (76.13%)
- BEATUSDT (74.32%)
- PIPPINUSDT (70.73%)
- FOLKSUSDT (66.64%)

**효과**:
- 예측 가능한 코인만 선택
- 안정적인 수익 가능성 증가

---

### 4. 속도 최적화 (펀딩비 캐싱)
**파일**: `src/backtesting/backtest_engine.py`, `src/strategies/entry_strategy.py`

**변경 전**:
```python
# 매 신호마다 펀딩비 API 호출 (970번)
for i in range(970):
    funding_info = get_funding_rate(symbol)  # API 호출
```

**변경 후**:
```python
# 코인당 1번만 펀딩비 조회
funding_info = get_funding_rate(symbol)  # 1번만

for i in range(970):
    signal = analyze_entry(..., funding_info=funding_info)  # 캐시 사용
```

**효과**:
- 펀딩비 조회 시간: 970번 → 1번
- 예상 속도 향상: 코인당 79.93초 → 약 10-15초
- 전체 시간: 13.3분 → 약 2-3분

---

## 📈 예상 결과

### 거래 통계 (예상):
- 총 거래 수: 1877개 → **800-1000개** (신호 필터 강화)
- 승률: 38.63% → **45-50%** (저품질 신호 제거)
- 평균 승리: $13.80 → **$18.40** (익절 2%)
- 평균 손실: -$11.20 (동일)

### 손익 계산 (예상):
```
거래 수: 900개
승률: 47%
승리: 423개 × $18.40 = $7,783
손실: 477개 × -$11.20 = -$5,342
순수익: $2,441 (+2.7%)
```

### 속도 개선 (예상):
- 코인당: 79.93초 → **10-15초** (5-8배 빠름)
- 전체: 13.3분 → **2-3분** (4-6배 빠름)

---

## 🎯 다음 단계

### 백테스트 실행:
```bash
python main_backtest.py
```

### 확인 사항:
1. ✅ 거래 수가 줄어들었는가? (1877 → 800-1000)
2. ✅ 승률이 올라갔는가? (38.63% → 45-50%)
3. ✅ 손익이 플러스인가? (-$2,897 → +$2,000 이상)
4. ✅ 속도가 빨라졌는가? (13.3분 → 2-3분)
5. ✅ 고변동성 코인이 제외되었는가?

### 추가 개선 가능 사항:
- 시간대별 분석 (특정 시간대에 승률이 높은지)
- 보유 시간 최적화 (현재 평균 24분)
- 동적 손익비 (변동성에 따라 조정)
- 거래량 필터 (거래량 급증 시 진입)

---

## 📝 변경 파일 목록

1. `config/config.py`
   - TAKE_PROFIT_PERCENT: 1.5 → 2.0
   - MAX_VOLATILITY: 50.0 추가

2. `src/strategies/entry_strategy.py`
   - 신뢰도 기준: 70/75 → 80/85
   - funding_info 파라미터 추가 (캐싱)

3. `src/backtesting/backtest_engine.py`
   - 변동성 필터 추가 (MAX_VOLATILITY)
   - 펀딩비 사전 조회 (캐싱)
   - 시간 분석 업데이트

---

## 💡 핵심 인사이트

1. **손익비가 승률보다 중요**: 승률 40%여도 손익비 2:1이면 수익
2. **신호 품질 > 신호 수량**: 1877개 → 900개로 줄여도 수익 증가 가능
3. **변동성 관리**: 70-80% 변동성은 도박, 20-50%가 적정
4. **속도 최적화**: API 호출 최소화가 핵심 (970번 → 1번)
